# Baseband-guard

一个面向 Android 内核的轻量级 **LSM（Linux Security Module）**，用于在系统层面阻止对关键分区/设备节点的非法写入，降低基带、引导链等关键组件被恶意/误操作篡改的风险。项目当前处于 **WIP**（进行中）状态。

---

## 目录

- [背景与目标](#背景与目标)
- [主要特性](#主要特性)
- [工作原理（简要）](#工作原理简要)
- [环境要求](#环境要求)
- [快速开始](#快速开始)
- [内核集成指南](#内核集成指南)
- [配置项](#配置项)
- [日志与调试](#日志与调试)
- [兼容性与限制](#兼容性与限制)
- [路线图](#路线图)
- [贡献指南](#贡献指南)
- [许可证](#许可证)
- [致谢](#致谢)

---

## 背景与目标

在移动设备中，**基带与引导链**属于高价值目标。一旦被写入恶意数据或被非预期工具覆盖，可能导致不可逆的**软砖/硬砖**，甚至引发**通信安全风险**。  
**Baseband-guard** 通过内核 LSM 钩子在**写路径**进行拦截，对高风险目标设备节点/分区进行保护，辅助开发者/系统构建者实现**最小可用、默认拒绝**的安全策略。

---

## 主要特性

- **内核态拦截**：通过 LSM 在系统层面拦截对受保护目标的写入尝试，避免用户态绕过。  
- **轻量易集成**：提供 `Kconfig`、`Makefile` 与 `setup.sh`，便于集成到 Android 内核树中构建。  
- **可维护性**：通过 `kernel_compat.h` 做兼容性拆分，降低不同内核版本适配负担。  
- **可配置**：受保护目标列表与匹配策略可在源码中维护（详见 `baseband_guard.c`，请依据你的产品需求调整）。

---

## 工作原理（简要）

Baseband-guard 作为 **LSM** 模块在关键文件写入路径安装钩子（例如对块设备节点、by-name 分区设备等），当检测到命中保护规则的**写**操作时进行拒绝，并在内核日志中记录事件，支持问题**可追溯**与**快速定位**。

> 该设计依赖 Linux LSM 框架与 Android 常见的分区/设备访问路径；具体实现细节见 `baseband_guard.c`。

---

## 环境要求

- Android 内核源码树（AOSP/common 或厂商内核树）  
- 可用的交叉编译工具链（与目标内核版本匹配）  
- 具备启用自定义 `Kconfig` 项与重新编译内核/boot 镜像的权限

---

## 快速开始(参考)

1. **拉取源码**：
   ```bash
   git submodule add https://github.com/vc-teahouse/Baseband-guard external/baseband_guard
   ```

2. **运行脚本（可选）**：
   ```bash
   cd external/baseband_guard
   bash setup.sh
   ```

3. **启用内核配置**：在 `menuconfig` / `defconfig` 中开启：
   ```text
   CONFIG_SECURITY_BASEBAND_GUARD=y
   ```

4. **编译与打包**：按你的项目流程重新构建内核与 `boot/vendor_boot` 镜像，并刷入测试设备。

5. **验证**：在受保护目标上模拟写入，确认被拒绝并产生日志。

---

## 内核集成指南

- 修改 `Kconfig` 与 `Makefile`，为模块增加可选项并加入构建产物。  
- 使用 `kernel_compat.h` 做不同内核接口的差异化适配。  
- 建议源码放入 `security/baseband_guard/`，并检查路径正确性。

---

## 配置项

- **内核配置**：通过 `Kconfig` 开关模块构建/启用状态。  
- **保护规则**：在 `baseband_guard.c` 维护匹配逻辑（如按设备路径、分区名、`/dev/block/by-name/*` 等）。

> 提示：为避免 OTA/恢复流程受影响，请为**合法的系统更新路径**保留例外。

---

## 日志与调试

- **内核日志**：`dmesg` 或 `logcat -b kernel` 中可见拒绝事件。  
- **排查建议**：确认 `lsm=` 参数、保护规则配置与不同模式（normal/recovery/fastbootd）的兼容性。

---

## 兼容性与限制

- **内核版本**：通过 `kernel_compat.h` 适配不同接口。  
- **设备差异**：需按机型维护规则集。  
- **与其他 LSM 并存**：注意加载顺序与钩子调用次序。  
- **状态**：仍在 WIP 阶段，生产环境请谨慎。

---

## 路线图

- [ ] 丰富规则匹配方式  
- [ ] OTA/恢复流程例外模板  
- [ ] sysfs/debugfs 可运行时策略接口  
- [ ] 单元/集成测试与 CI

---

## 贡献指南

- 提交前请说明测试平台与修改内容。  
- 遵守内核风格（函数命名、日志等级、错误路径处理）。  
- 若涉及兼容性宏，请更新 `kernel_compat.h`。

---

## 许可证

本项目采用 **GPL-2.0** 许可证，详见 `LICENSE`。

---


### 本项目仓库地址

- GitHub: [vc-teahouse/Baseband-guard](https://github.com/vc-teahouse/Baseband-guard)
